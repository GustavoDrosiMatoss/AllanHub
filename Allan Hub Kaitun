-- Allan Hub com Fluent, Auto Farm otimizado e Fruit Fix
local Fluent = loadstring(game:HttpGet("https://github.com/dawid-scripts/Fluent/releases/latest/download/main.lua"))()

local Window = Fluent:CreateWindow({
    Title = "Allan Hub",
    SubTitle = "By Allan",
    TabWidth = 120,
    Size = UDim2.fromOffset(500, 350),
    Acrylic = true,
    Theme = "Dark"
})

-- Tabs principais
local Tabs = {
    Main = Window:AddTab({ Title = "Main", Icon = "home" }),
    Farm = Window:AddTab({ Title = "Auto Farm", Icon = "sword" }),
    Teleport = Window:AddTab({ Title = "Teleport", Icon = "map" }),
    Settings = Window:AddTab({ Title = "Settings", Icon = "settings" }),
}

-- Função de Auto Farm Inteligente
function SmartAutoFarm()
    spawn(function()
        while getgenv().AutoFarm do
            pcall(function()
                local player = game.Players.LocalPlayer
                local char = player.Character
                local hum = char and char:FindFirstChild("Humanoid")
                local root = char and char:FindFirstChild("HumanoidRootPart")

                -- [1] Respawn seguro caso morra
                if not root or not hum or hum.Health <= 0 then
                    repeat task.wait(1) until player.Character and player.Character:FindFirstChild("HumanoidRootPart")
                    char = player.Character
                    root = char:WaitForChild("HumanoidRootPart")
                end

                -- [2] Verificar NPC mais próximo dentro da área de farm
                local targetMob, targetDist
                for _, mob in pairs(workspace.Enemies:GetChildren()) do
                    if mob:FindFirstChild("HumanoidRootPart") and mob:FindFirstChild("Humanoid") and mob.Humanoid.Health > 0 then
                        local dist = (mob.HumanoidRootPart.Position - root.Position).Magnitude
                        if not targetDist or dist < targetDist then
                            targetMob = mob
                            targetDist = dist
                        end
                    end
                end

                if targetMob then
                    -- [3] Movimentação rápida e segura
                    local distance = targetDist
                    local speed = math.clamp(distance / 10, 100, 500)
                    local tween = game:GetService("TweenService"):Create(
                        root,
                        TweenInfo.new(distance / speed, Enum.EasingStyle.Linear),
                        {CFrame = targetMob.HumanoidRootPart.CFrame * CFrame.new(0, 0, 3)}
                    )
                    tween:Play()
                    tween.Completed:Wait()

                    -- [4] Equipar arma automaticamente se não estiver equipada
                    local equipped = char:FindFirstChildWhichIsA("Tool")
                    if not equipped then
                        for _, v in pairs(player.Backpack:GetChildren()) do
                            if v:IsA("Tool") and not v:FindFirstChild("RemoteFunction") then
                                hum:EquipTool(v)
                                break
                            end
                        end
                    end

                    -- Atacar mob
                    if equipped then
                        game:GetService("VirtualUser"):Button1Down(Vector2.new(), workspace.CurrentCamera.CFrame)
                        task.wait(0.2)
                        game:GetService("VirtualUser"):Button1Up(Vector2.new(), workspace.CurrentCamera.CFrame)
                    end
                end

                task.wait(0.1)
            end)
        end
    end)
end

-- Toggle de Auto Farm na aba Farm
Tabs.Farm:AddToggle({
    Title = "Auto Farm",
    Default = false,
    Callback = function(Value)
        getgenv().AutoFarm = Value
        if Value then
            SmartAutoFarm()
        end
    end
})

-- Função para pausar Auto Farm ao detectar fruta no chão
function CheckFruitOnGround()
    spawn(function()
        while task.wait(2) do
            pcall(function()
                for _, obj in pairs(workspace:GetChildren()) do
                    if obj:IsA("Tool") and obj:FindFirstChild("Handle") and string.find(obj.Name, "Fruit") then
                        -- Desativar Auto Farm
                        if getgenv().AutoFarm then
                            getgenv().AutoFarm = false
                            print("[Allan Hub] Fruta detectada, pausando Auto Farm...")
                        end

                        -- Teleportar até a fruta e coletar
                        local root = game.Players.LocalPlayer.Character and game.Players.LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
                        if root then
                            root.CFrame = obj.Handle.CFrame + Vector3.new(0, 2, 0)
                        end

                        repeat task.wait() until not obj or not obj.Parent

                        -- Reativar Auto Farm
                        getgenv().AutoFarm = true
                        SmartAutoFarm()
                        print("[Allan Hub] Fruta coletada, Auto Farm retomado.")
                    end
                end
            end)
        end
    end)
end

-- Ativar checagem de frutas
CheckFruitOnGround()
